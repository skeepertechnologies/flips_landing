<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>FLIPS Blog - Environmental Insights</title>
  <meta name="description" content="Explore FLIPS' insights on flood prediction, water management, and environmental monitoring.">
  <meta name="keywords" content="flood prediction, environmental data, water management, FLIPS blog, AI modeling">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Inter:wght@100;200;300;400;500;600;700;800;900&family=Nunito:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">

  <!-- Custom CSS for Blog -->
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f8f9fa;
    }
    .blog-section {
      padding: 80px 0;
      background: #fff;
    }
    .blog-post {
      margin-bottom: 60px;
    }
    .blog-post img {
      width: 100%;
      height: 400px;
      object-fit: cover;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
    }
    .blog-post h2 {
      font-size: 2rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 20px;
    }
    .blog-post .meta {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 20px;
    }
    .blog-post .content {
      font-size: 1rem;
      color: #444;
      line-height: 1.8;
      margin-bottom: 30px;
    }
    .comments-section {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
    }
    .comments-section h3 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
    }
    .comment {
      margin-bottom: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .comment.reply {
      margin-left: 40px;
      background: #f1f1f1;
    }
    .comment .comment-author {
      font-weight: 600;
      color: #333;
    }
    .comment .comment-meta {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 10px;
    }
    .comment .comment-content {
      font-size: 0.95rem;
      color: #444;
    }
    .comment .reply-link {
      color: #7b4d11;
      font-size: 0.85rem;
      text-decoration: none;
    }
    .comment .reply-link:hover {
      color: #5a370d;
      text-decoration: underline;
    }
    .comment-form {
      margin-top: 30px;
    }
    .comment-form .btn-primary {
      background: #7b4d11;
      border: none;
    }
    .comment-form .btn-primary:hover {
      background: #5a370d;
    }
    .header {
      background: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .btn-getstarted {
      background: #7b4d11;
      color: #fff;
      border: none;
    }
    .btn-getstarted:hover {
      background: #5a370d;
    }
    @media (max-width: 768px) {
      .blog-post img {
        height: 300px;
      }
      .blog-post h2 {
        font-size: 1.5rem;
      }
      .comment.reply {
        margin-left: 20px;
      }
    }
  </style>
</head>

<body class="blog-page">
  <!-- Header -->
  <header id="header" class="header d-flex align-items-center fixed-top">
    <div class="container-fluid container-xl position-relative d-flex align-items-center justify-content-between">
      <a href="index.html" class="logo d-flex align-items-center me-auto me-xl-0">
        <img src="assets/img/logo.png" alt="FLIPS Logo" class="img-fluid">
      </a>
      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="index.html#hero" class="nav-link fw-bold">Home</a></li>
          <li><a href="index.html#about" class="nav-link fw-bold">About</a></li>
          <li><a href="about-water.html" class="nav-link fw-bold">About Water</a></li>
          <li><a href="about-ai.html" class="nav-link fw-bold">About AI</a></li>
          <li><a href="index.html#features" class="nav-link fw-bold">Features</a></li>
          <li><a href="index.html#services" class="nav-link fw-bold">Services</a></li>
          <li><a href="index.html#pricing" class="nav-link fw-bold">Pricing</a></li>
          <li><a href="index.html#contact" class="nav-link fw-bold">Contact</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
      <div id="user-status">
        <a class="btn btn-getstarted fw-bold" href="login/login.html">Get Started</a>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <!-- Blog Section -->
    <section id="blog" class="blog-section">
      <div class="container" data-aos="fade-up">
        <div class="section-title text-center mb-5">
          <h2>Environmental Insights Blog</h2>
          <p>Read our latest articles on flood prediction, water management, and environmental monitoring.</p>
        </div>
        <div id="blog-posts">
          <!-- Blog posts will be populated dynamically -->
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer id="footer" class="footer">
    <div class="container footer-top">
      <div class="row gy-4">
        <div class="col-lg-4 col-md-6 footer-about">
          <a href="index.html" class="logo d-flex align-items-center">
            <span class="sitename">FLIPS</span>
          </a>
          <div class="footer-contact pt-3">
            <p>Nairobi, Kenya</p>
            <p class="mt-3"><strong>Phone:</strong> <span>+254 700 168 812</span></p>
            <p><strong>Email:</strong> <span>flipsintelligence@gmail.com</span></p>
          </div>
          <div class="social-links d-flex mt-4">
            <a href=""><i class="bi bi-twitter-x"></i></a>
            <a href=""><i class="bi bi-facebook"></i></a>
            <a href="https://www.instagram.com/flips.intel"><i class="bi bi-instagram"></i></a>
            <a href=""><i class="bi bi-linkedin"></i></a>
          </div>
        </div>
        <div class="col-lg-2 col-md-3 footer-links">
          <h4>Useful Links</h4>
          <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="index.html#about">About us</a></li>
            <li><a href="index.html#services">Services</a></li>
            <li><a href="#">Terms of service</a></li>
            <li><a href="#">Privacy policy</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-md-3 footer-links">
          <h4>Our Services</h4>
          <ul>
            <li><a href="#">Water management</a></li>
            <li><a href="#">Flood prediction</a></li>
            <li><a href="#">River water level reading</a></li>
            <li><a href="#">ML prediction</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="container copyright text-center mt-4">
      <p>Â© <span>Copyright</span> <strong class="px-1 sitename">FLIPS</strong> <span>All Rights Reserved</span></p>
    </div>
  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center" style="background: #7b4d11; bottom: 90px; right: 30px;"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>

  <!-- Main JS File -->
  <script src="assets/js/main.js"></script>

  <!-- Custom JS for Blog and Comments -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // AOS Initialization
      AOS.init({
        duration: 1000,
        once: true,
      });

      // User Status Handling
      const userStatus = document.getElementById('user-status');
      const loggedInUser = sessionStorage.getItem('loggedInUser');
      const token = sessionStorage.getItem('token');

      if (loggedInUser) {
        const user = JSON.parse(loggedInUser);
        userStatus.innerHTML = `
          <div class="dropdown">
            <button class="btn btn-getstarted fw-bold dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              Welcome, ${user.username}
            </button>
            <ul class="dropdown-menu" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="dashboard.html">Dashboard</a></li>
              <li><a class="dropdown-item" href="#" id="logoutBtn">Logout</a></li>
            </ul>
          </div>
        `;
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
          e.preventDefault();
          sessionStorage.removeItem('loggedInUser');
          sessionStorage.removeItem('token');
          window.location.href = 'index.html';
        });
      } else {
        userStatus.innerHTML = '<a class="btn btn-getstarted fw-bold" href="login/login.html">Get Started</a>';
        document.querySelectorAll('.comment-form').forEach(form => {
          if (form) form.innerHTML = '<p>Please <a href="login/login.html">log in</a> to post a comment.</p>';
        });
      }

      // Fetch Blog Posts and Comments
      async function fetchBlogPosts() {
        try {
          const response = await fetch('http://your-django-api-url/api/blogs/', {
            headers: {
              'Authorization': `Bearer ${token || ''}`
            }
          });
          const blogs = await response.json();
          const blogContainer = document.getElementById('blog-posts');
          blogContainer.innerHTML = blogs.results.map((blog, index) => `
            <div id="post-${blog.id}" class="blog-post" data-aos="fade-up" data-aos-delay="${100 + index * 100}">
              <h2>${blog.title}</h2>
              <div class="meta">Posted by ${blog.author.username} on ${new Date(blog.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
              <img src="${blog.image || 'https://via.placeholder.com/800x400?text=Blog+Image'}" alt="${blog.title}">
              <div class="content">${blog.content}</div>
              <div class="comments-section" id="comments-${blog.id}">
                <h3>Comments</h3>
                <div id="comment-list-${blog.id}">
                  <!-- Comments will be populated dynamically -->
                </div>
                ${loggedInUser ? `
                  <form class="comment-form" data-blog-id="${blog.id}" onsubmit="submitComment(event, ${blog.id})">
                    <textarea class="form-control mb-3" rows="5" placeholder="Add a Comment" required></textarea>
                    <button type="submit" class="btn btn-primary">Post Comment</button>
                  </form>
                ` : '<p>Please <a href="login/login.html">log in</a> to post a comment.</p>'}
              </div>
            </div>
          `).join('');

          // Fetch comments for each blog
          blogs.results.forEach(blog => fetchComments(blog.id));
        } catch (error) {
          console.error('Error fetching blog posts:', error);
        }
      }

      // Fetch Comments for a Blog
      async function fetchComments(blogId) {
        try {
          const response = await fetch(`http://your-django-api-url/api/comments/?blog_id=${blogId}`, {
            headers: {
              'Authorization': `Bearer ${token || ''}`
            }
          });
          const comments = await response.json();
          const commentList = document.getElementById(`comment-list-${blogId}`);
          commentList.innerHTML = comments.map(comment => renderComment(comment, blogId)).join('');
        } catch (error) {
          console.error(`Error fetching comments for blog ${blogId}:`, error);
        }
      }

      // Render a Comment (with Nested Replies)
      function renderComment(comment, blogId) {
        const replies = comment.replies.map(reply => `
          <div class="comment reply" id="comment-${reply.id}">
            <div class="comment-author">${reply.user.username}</div>
            <div class="comment-meta">${new Date(reply.created_at).toLocaleString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true })}</div>
            <div class="comment-content">${reply.content}</div>
            <a href="#" class="reply-link" onclick="showReplyForm('reply-form-${reply.id}')">Reply</a>
            <form id="reply-form-${reply.id}" class="comment-form reply-form d-none" onsubmit="submitComment(event, ${blogId}, ${reply.id})">
              <textarea class="form-control mb-3" rows="3" placeholder="Your Reply" required></textarea>
              <button type="submit" class="btn btn-primary">Post Reply</button>
            </form>
          </div>
        `).join('');

        return `
          <div class="comment" id="comment-${comment.id}">
            <div class="comment-author">${comment.user.username}</div>
            <div class="comment-meta">${new Date(comment.created_at).toLocaleString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true })}</div>
            <div class="comment-content">${comment.content}</div>
            <a href="#" class="reply-link" onclick="showReplyForm('reply-form-${comment.id}')">Reply</a>
            <form id="reply-form-${comment.id}" class="comment-form reply-form d-none" onsubmit="submitComment(event, ${blogId}, ${comment.id})">
              <textarea class="form-control mb-3" rows="3" placeholder="Your Reply" required></textarea>
              <button type="submit" class="btn btn-primary">Post Reply</button>
            </form>
            ${replies}
          </div>
        `;
      }

      // Show Reply Form
      function showReplyForm(formId) {
        const form = document.getElementById(formId);
        form.classList.toggle('d-none');
      }

      // Submit Comment
      async function submitComment(event, blogId, parentId = null) {
        event.preventDefault();
        const loggedInUser = sessionStorage.getItem('loggedInUser');
        const token = sessionStorage.getItem('token');

        if (!loggedInUser || !token) {
          alert('Please log in to post a comment.');
          window.location.href = 'login/login.html';
          return;
        }

        const form = event.target;
        const content = form.querySelector('textarea').value;

        try {
          const response = await fetch('http://your-django-api-url/api/comments/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              blog: blogId,
              content: content,
              parent: parentId
            })
          });

          if (response.ok) {
            form.reset();
            if (parentId) form.classList.add('d-none');
            fetchComments(blogId); // Refresh comments
          } else {
            alert('Error posting comment. Please try again.');
          }
        } catch (error) {
          console.error('Error posting comment:', error);
          alert('Error posting comment. Please try again.');
        }
      }

      // Initial Fetch
      fetchBlogPosts();
    });
  </script>
</body>
</html>