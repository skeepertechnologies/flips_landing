<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Privacy Policy | FLIPS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.12.1/font/bootstrap-icons.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #f0f2f8, #e6e9f0);
            font-family: Candara, sans-serif;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            position: relative;
        }
        .card {
            width: 100%;
            max-width: 600px;
            border-radius: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 2;
            margin: 2rem 0;
        }
        .card-title {
            font-weight: bold;
            color: #7b4d11;
        }
        .btn-primary {
            background-color: #7b4d11;
            border-color: #7b4d11;
            border-radius: 0;
            font-weight: bold;
        }
        .btn-primary:hover {
            background-color: #5c3a0d;
            border-color: #5c3a0d;
        }
        .btn-outline-primary {
            border-color: #7b4d11;
            color: #7b4d11;
            border-radius: 0;
            font-weight: bold;
        }
        .btn-outline-primary:hover {
            background-color: #7b4d11;
            color: white;
        }
        .alert-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .alert {
            border-radius: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        h2, h3 {
            color: #7b4d11;
        }
        p, li {
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .policy-content {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 1rem;
        }
    </style>
</head>
<body>
    <video autoplay muted loop playsinline class="position-fixed w-100 h-100 object-fit-cover z-n1" style="filter: blur(4px); transform: scale(1.05);">
        <source src="../assets/video/bg.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div class="card shadow-lg p-4">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-center mb-4">
                <img src="../assets/img/logo.png" alt="FLIPS" style="height: 40px;">
            </div>
            <h6 class="card-title mb-4 text-center">FLIPS Privacy Policy</h6>
            <div class="policy-content" role="region" aria-labelledby="privacy-policy-heading">
                <h2 id="privacy-policy-heading">Privacy Policy</h2>
                <p><strong>Last Updated: May 13, 2025</strong></p>
                <p>At FLIPS, we are committed to protecting your privacy and ensuring the security of your personal information. This Privacy Policy explains how we collect, use, share, and protect your data when you use our platform and services.</p>
                <!-- Rest of the privacy policy content remains unchanged -->
            </div>
            <button class="btn btn-primary w-100 mt-4" id="acceptPolicyBtn">Accept Privacy Policy</button>
            <a href="login.html" class="btn btn-outline-primary w-100 mt-3">Back to Login</a>
        </div>
    </div>

    <div class="alert-container" id="alertContainer">
        <div class="alert alert-success alert-dismissible fade d-none" id="successAlert" role="alert">
            <strong>Success!</strong> Privacy policy accepted.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div class="alert alert-danger alert-dismissible fade d-none" id="errorAlert" role="alert">
            <strong>Error!</strong> Failed to accept privacy policy. Please try again.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div class="alert alert-warning alert-dismissible fade d-none" id="authAlert" role="alert">
            <strong>Login Required!</strong> Please log in to accept the privacy policy.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        const BASE_URL = 'https://api.flipsintel.org';

        function showAlert(alertId, message) {
            const alerts = ['successAlert', 'errorAlert', 'authAlert'];
            alerts.forEach(id => {
                const alert = document.getElementById(id);
                alert.classList.add('d-none');
                alert.classList.remove('show');
            });

            const targetAlert = document.getElementById(alertId);
            if (message) {
                targetAlert.querySelector('strong').nextSibling.textContent = ` ${message}`;
            }
            targetAlert.classList.remove('d-none');
            targetAlert.classList.add('show');
            if (alertId === 'successAlert') {
                setTimeout(() => {
                    const redirectUrl = localStorage.getItem('redirectAfterPrivacy') || '../dashboard/index.html';
                    window.location.href = redirectUrl;
                }, 2000);
            } else if (alertId === 'authAlert') {
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            } else {
                setTimeout(() => {
                    targetAlert.classList.remove('show');
                    setTimeout(() => targetAlert.classList.add('d-none'), 150);
                }, 5000);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            console.log('Token on page load:', token);
            if (!token) {
                showAlert('authAlert', 'Please log in to accept the privacy policy.');
                return;
            }

            try {
                const response = await axios.get(`${BASE_URL}/userprofile/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                console.log('User profile:', response.data);
                if (response.data.has_accepted_privacy_policy) {
                    console.log('Privacy policy already accepted, redirecting to dashboard');
                    const redirectUrl = localStorage.getItem('redirectAfterPrivacy') || '../dashboard/index.html';
                    window.location.href = redirectUrl;
                }
            } catch (error) {
                console.error('Profile fetch failed:', error.response?.data || error.message);
                showAlert('authAlert', 'Invalid session. Please log in again.');
                localStorage.removeItem('token');
            }
        });

        document.getElementById('acceptPolicyBtn').addEventListener('click', async function () {
            const token = localStorage.getItem('token');
            console.log('Retrieved token:', token);
            if (!token) {
                showAlert('authAlert', 'Please log in to accept the privacy policy.');
                return;
            }

            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Accepting...';

            try {
                const response = await axios.post(`${BASE_URL}/userprofile/accept-privacy-policy/`, {}, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                console.log('Privacy policy accepted:', response.data);
                showAlert('successAlert');
            } catch (error) {
                console.error('Failed to accept privacy policy:', error.response?.data || error.message);
                const errorMessage = error.response?.data?.error || 'Failed to accept privacy policy. Please try again.';
                showAlert('errorAlert', errorMessage);
            } finally {
                this.disabled = false;
                this.innerHTML = 'Accept Privacy Policy';
            }
        });
    </script>
</body>
</html>